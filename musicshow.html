<html>

<head>

    <!--
    <?php
    $titles = ["a muse", "amusing", "a-musical"];
    $title = array_rand($titles);
    echo "<title>".$title."</title>";
    ?>
    -->
    <title>a muse;amusing;a-musical.</title>

    <style type="text/css">
    body {
        font-family: monospace;
        font-size: 13px;
    }
    .centered {
        position: relative;
        max-width: 1400px;
        height: auto;
        margin: auto;
        padding: 10px;
        text-align: center;
    }
    </style>
    <script src="music.js">
    // music node stuff
    </script>
    <script src="colors.js">
    // color functions
    </script>
    <script type="text/javascript">

    var canvasID = "drawspace";
    var leCanvas;
    var leContext;

    var dispnodes = [];
    var lastshown;
    
    var colors = getColorsLib();
    
    var BASEPLATE_STYLE = "gray";
    var DEFAULT_STYLE = "white";
    var DEFAULT_TEXT_WIDTH = 100;
    var FONT_SIZE = 30;
    var DEFAULT_FONT = FONT_SIZE + "px Helvetica";
    var DEFAULT_TEXT_FILL = "white";
    var DEFAULT_TEXT_STROKE = "black";

    function plotRect(context, x, y, width, height, fillStyle, strokeStyle, lineWidth) {
        if (fillStyle) {
            context.fillStyle = fillStyle;
            context.fillRect(x, y, width, height);
        }
        if (strokeStyle) {
        	if(lineWidth){
        		context.lineWidth = lineWidth;
        	}
        	context.strokeStyle = strokeStyle;
            context.beginPath();
            context.rect(x, y, width, height);
            context.stroke();
        }
    }

    function plotText(text, context, x, y, maxWidth, font, fillStyle, strokeStyle){
    	context.font = font;
    	context.fillStyle = fillStyle;
        context.strokeStyle = strokeStyle;
    	context.fillText(text, x, y, maxWidth);
        context.strokeText(text, x, y, maxWidth);
    }

    function showNode(node, x, y, width, height, yshrink, childfunction) {
    	yshrink = yshrink || 10;
    	console.log("showNode: plotting node (recursive)");
        plotRect(leContext, x, y, width, height, getStyle(node), "black", 1); // baseplate
        if( node.value instanceof Array ){
			console.log("showNode: node value is an array");
			var lastStartPos = 0;
			for(var i = 0; i < node.value.length; i++){
				var subdur = node.value[i].getDuration();
				var subwidth = width * subdur / node.getDuration();
				showNode(node.value[i], x + lastStartPos, y+yshrink, subwidth, height-1*yshrink, yshrink, childfunction);
				lastStartPos += subwidth;
			}
		}
        else if(node.value instanceof Note){
            plotText(node.value.num, leContext, x + 3, y + yshrink, DEFAULT_TEXT_WIDTH, DEFAULT_FONT, DEFAULT_TEXT_FILL, DEFAULT_TEXT_STROKE);
            plotText(note_association[node.value.num], leContext, x + 3, y + yshrink + FONT_SIZE, DEFAULT_TEXT_WIDTH, DEFAULT_FONT, DEFAULT_TEXT_FILL, DEFAULT_TEXT_STROKE);
        }
        return true;
    }
    
    /*
    function sell_drinks(){
        console.log("HI");
    }
    */

    /*
 
    function showNode_Iter(root, x, y, width, height, yshrink){
        // unfinished
        /*
        var dispHelper = {};
        yshrink = yshrink || 10;
        console.log("showNode: plotting node (iterative)");
        var queue = [nodeLevelObj(root, 0)];
        while(queue.length > 0){
            var nodeObj = queue.shift();
            console.log("showNode: examining node at level " + nodeObj.level);
            console.log(nodeObj);
            if(!dispHelper[nodeObj.level]){
                dispHelper[nodeObj.level] = [];
            }
            dispHelper[nodeObj.level].push(nodeObj.node);
            if(!(nodeObj.node.value instanceof Array)){
                //plotRect(leContext, x, y, width, height, getStyle(nodeObj.node, nodeObj.level), "black", 1);
                continue;
            }
            // else...
            for(var i = 0; i < nodeObj.node.value.length; i++){
                queue.push(nodeLevelObj(nodeObj.node.value[i], nodeObj.level+1));
            }
            //plotRect(leContext, x, y, width, height, getStyle(nodeObj.node, nodeObj.level), "black", 1);
        }
        return dispHelper;

        // assuming I already did everything with reSequence
    }*/


    function loadCanvas() {
        leCanvas = document.getElementById(canvasID);
        leContext = leCanvas.getContext("2d");
    }

    function newsection() {
        var noda = BuildRhythm(4, PATTERNS, 10, 4);
        Tonalize(noda);
        showNode(noda, 20, 20, 1000, 250, 20);
        dispnodes.push(noda);
        lastshown = noda;
    }

    function getStyle(node, level) {        
        var TEMP_GLOBAL_NUM_TONES = 12;
    	//level = level || 0;
        console.debug("getStyle debug");
        console.debug(node);
        if (node.value instanceof Note) {
            console.debug("note " + node.value)
            return colors.getStyleFromRGB(colors.HSVtoRGB( (node.value.num % TEMP_GLOBAL_NUM_TONES) / TEMP_GLOBAL_NUM_TONES, 1, 1));
        }
        else if (node.value instanceof Array) {
        	if(!level){
        		return BASEPLATE_STYLE;
        	}
        }
    	return DEFAULT_STYLE;
    }

    </script>
</head>
<body onload="loadCanvas()">
    <div class=centered>
        <button onclick="newsection()">New Section</button>
        <hr>
            <canvas id="drawspace" width="1200" height="720" style="border: 1px solid black"></canvas>
        
    </div>
</body>
</html>

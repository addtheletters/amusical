<html>

<head>

    <title id="tt">a muse;amusing;a-musical.</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
	
    <script src="js/MIDI.js">/* MIDI API */</script>
    
    <script src="inc/shim/Base64.js" type="text/javascript"></script>
    <script src="inc/shim/Base64binary.js" type="text/javascript"></script>
    <script src="inc/shim/WebAudioAPI.js" type="text/javascript"></script>
    
    <script src="js/music.js">/* music node stuff */</script>
    <script src="js/colors.js">/* color functions */</script>
    <script src="js/plotting.js">/* extremely simple canvas drawing */</script>
    <script src="js/sequencerealizer.js">/* rendering node as html */</script>
    <link rel="stylesheet" type="text/css" href="css/realized.css">
    <link rel="stylesheet" type="text/css" href="css/musiclabels.css"> 
    
    <script type="text/javascript">
    
    
    var titles = ["musical", "a muse", "amusing", "a-musical", "amusante", "a muse kale", "a moose king", "aim use sling", "ah moose aunt"];

    var canvasID = "drawspace";
    var leCanvas;
    var leContext;

    var dispnodes = [];
    var last_shown;
    var loop_timeout;
    var should_loop;
    
    var colors = getColorsLib();
    
    var BASEPLATE_STYLE = "gray";
    var DEFAULT_STYLE = "white";
    var DEFAULT_TEXT_WIDTH = 50;
    var FONT_SIZE = 15;
    var DEFAULT_FONT = FONT_SIZE + "px Monospace";
    var DEFAULT_TEXT_FILL = "white";
    var DEFAULT_TEXT_STROKE = "rgba(0, 0, 0, 0)";

    function showNode(node, x, y, width, height, yshrink, childfunction) {
    	yshrink = yshrink || 10;
    	//console.log("showNode: plotting node (recursive)");
        plot.Rect(leContext, x, y, width, height, getStyle(node), "black", 1); // baseplate
        if( node.value instanceof Array ){
			//console.log("showNode: node value is an array");
			var lastStartPos = 0;
			for(var i = 0; i < node.value.length; i++){
				var subdur = node.value[i].getDuration();
				var subwidth = width * subdur / node.getDuration();
				showNode(node.value[i], x + lastStartPos, y+yshrink, subwidth, height-1*yshrink, yshrink, childfunction);
				lastStartPos += subwidth;
			}
		}
        else if(node.value instanceof music.Note){
            plot.Text(node.value.num, leContext, x + 3, y + yshrink, DEFAULT_TEXT_WIDTH, DEFAULT_FONT, DEFAULT_TEXT_FILL, DEFAULT_TEXT_STROKE);
            plot.Text(node.value.toSPN(), leContext, x + 3, y + yshrink + FONT_SIZE, DEFAULT_TEXT_WIDTH, DEFAULT_FONT, DEFAULT_TEXT_FILL, DEFAULT_TEXT_STROKE);
        }
        return true;
    }

    function getStyle(node, level) {
    	//level = level || 0;
        if (node.value instanceof music.Note) {
            return colors.getStyleFromRGB(colors.HSVtoRGB(getIndicHSV(node.value)));
        }
        else if (node.value instanceof Array) {
        	if(!level){
        		return BASEPLATE_STYLE;
        	}
        }
    	return DEFAULT_STYLE;
    }
    
    function getIndicHSV(note){
        intensity = ( Math.pow( note.toSPN().octave, 1.5) / Math.pow(4, 1.5));
        noteHSV = {
            h:mod(note.num, music.NUM_TONES) / music.NUM_TONES,
            s:1,
            v:intensity/1.5
        };
        return noteHSV;
    }
    
    function loadCanvas() {
        document.title = titles.randomChoice();

        leCanvas = document.getElementById(canvasID);
        leContext = leCanvas.getContext("2d");
        
        MIDI.loadPlugin({
            soundfontUrl: "./soundfont/",
            instrument: "acoustic_grand_piano",
            onprogress: function(state, progress) {
                //console.log(state, progress);
            },
            onsuccess: function() {
                var ld = document.getElementById("loaded");
                ld.innerHTML = "[loaded!]";
                ld.classList.remove("disabled");
                ld.classList.add("enabled");
                setTimeout( function(){ ld.classList.add("faded") }, 5000 );
                /*
                var delay = 0; // play one note every quarter second
                var note = 50; // the MIDI note
                var velocity = 127; // how hard the note hits
                // play the note
                MIDI.setVolume(0, 127);
                MIDI.noteOn(0, note, velocity, delay);
                MIDI.noteOff(0, note, delay + 0.75);
                */
            }
        });
        
        clearInfo();
        loopToggle( document.getElementById("loopbox") );
        newSection();
    }
    
    function playNote( channel, note, velocity, duration, delay ){
        MIDI.setVolume(0, velocity);
        MIDI.noteOn(0, note, velocity, delay);
        MIDI.noteOff(0, note, delay + duration);
    }
    
    function playNode( node, channel, volume ){
        //console.log("beginning play of ", node);
        if(node.domElement){
            //console.log("lighten!");
            //console.log(node.domElement);
            node.domElement.classList.add("playing");
        }
        
        if( node.value instanceof Array ){
            (function playSequential( nde, index){
                //console.log("playing ", nde, " index ", index);
                playNode( nde.value[index], channel, volume );
                if( index < nde.value.length - 1 ){
                    //console.log("set timeout for", nde, nde.value[index].getDuration() * 1000);
                    setTimeout( function(){ playSequential(nde, index+1) }, nde.value[index].getDuration() * 1000 );
                }
            })( node, 0 );
        }
        else if(node.value instanceof music.Note){
            //console.log("sound", node.value);
            playNote(channel, node.value.num, volume, node.getDuration(), 0);
        }
        
        if(node.domElement){
            setTimeout( function(){ node.domElement.classList.remove("playing"); }, node.getDuration() * 1000 );
        }
        //console.log("completed play of ", node);
    }
    
    function loopToggle( cb ){
        //console.log("checkbox is", cb.checked);
        should_loop = cb.checked;
        if(cb.checked){
            document.getElementById("loopbox_label").classList.remove("disabled");
            document.getElementById("loopbox_label").classList.add("enabled");
        }
        else{
            document.getElementById("loopbox_label").classList.remove("enabled");
            document.getElementById("loopbox_label").classList.add("disabled");
        }
        if(should_loop == false){
            clearTimeout(loop_timeout);
        }
    }
    
    function playTriggered(){
        clearTimeout(loop_timeout);
        playNode(last_shown, 0, 127);
        if( should_loop ){
            //console.log(last_shown.getDuration()*1000);
            loop_timeout = setTimeout(function(){playTriggered();}, last_shown.getDuration()*1000);
        }
    }
    
    function showInfo(info, box_number){
        var ib = document.getElementById("infobox" + box_number);
        ib.innerHTML = info;
    }
    
    function clearInfo(){
        showInfo("[._.]", 0);
        showInfo("[~.~]", 1);
    }

    function newSection() {
        var noda = music.BuildRhythm(4, music.PATTERNS, 10, 5);
        var sca = music.scales.randomChoice();
        music.Tonalize(noda, sca.sequence);
        showNode(noda, 20, 20, 1000, 150, 20);
        clearInfo();
        showInfo(sca, 0); // make scales a js object so they can be named / categorized?
        dispnodes.push(noda);
        last_shown = noda;
        testRender();
    }
    
    function testRender(){
        var rdr = document.getElementById("render");
        if( rdr.children.length < 1 ){
            rdr.appendChild( renderNode(last_shown, 1000, 0) );
        }
        else{
            rdr.replaceChild( renderNode(last_shown, 1000, 0), rdr.firstChild )
        }
    }

    </script>
</head>
<body onload="loadCanvas();">
    <span id="loaded" class="info disabled">[loading MIDI library...]</span>
    <div class=centered>
        <button onclick="newSection();">New Section</button>
        <hr>
        <div>
            <button onclick="playTriggered();">Play Sequence</button> <label id="loopbox_label"><input id="loopbox" type="checkbox" onclick="loopToggle(this);">Loop?</label>
        </div>
        <hr>
        <span id="infobox0" class=info></span>
        <br><br>
        <span id="infobox1" class=info></span>
        <hr>
        <div id=render></div>
        <hr>
        <canvas id="drawspace" width="1200" height="200" style="border: 1px solid black"></canvas>
    </div>
</body>
</html>
